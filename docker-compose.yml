# =============================================================================
# CobraML2 Docker Compose Configuration
# Usage:
#   docker compose build      - Build the development image
#   docker compose run dev    - Start interactive shell
#   docker compose run dev cmake -B build -DCOBRAML2_BUILD_TESTS=ON && cmake --build build
# =============================================================================
services:
  dev:
    build:
      context: .
      dockerfile: Dockerfile
    image: cobraml2-dev:cuda13-gcc13
    container_name: cobraml2-dev
    
    # Mount source code (read-write for development)
    volumes:
      - .:/workspace:rw
      # Persist build directory across container restarts
      - cobraml2-build:/workspace/build
    
    # GPU access
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    
    # Interactive shell by default
    stdin_open: true
    tty: true
    
    # Working directory
    working_dir: /workspace
    
    # Environment variables for consistent builds
    environment:
      - CUDAHOSTCXX=/usr/bin/g++-13
      - CMAKE_BUILD_PARALLEL_LEVEL=8

# Named volume for persistent build cache
volumes:
  cobraml2-build:

